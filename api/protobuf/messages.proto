syntax = "proto3";
package io.clbs.octopusmq.protobuf;

import "google/protobuf/duration.proto";

option go_package = "github.com/clbs-io/octopusmq/api/protobuf";

// Item represents a queue item that has been pulled from the queue.
message Item {
  // Unique identifier of the item. It is generated by the server.
  // ID is optional, for case when you are enqueueing new item
  // ID is not suppose to be set by the client, but is generated by the server.
  uint64 id = 1;
  // Priority of the item. The lower the value, the lower the priority.
  uint32 priority = 2;
  // Grouping key of the item. Items with the same key are grouped and returned together to the same receiver when the first groupped item hits the head.
  // For example, if the first item with key "A" is pulled, all items with key "A" will be returned to the same receiver immediately after the first item is pulled.
  // Grouping has higher priority than priority.
  bytes key = 3;
  // Unique key, can be empty.
  bytes unique_key = 4;
  // Payload of the item.
  bytes value = 5;
}

// InputItem represents an item to be enqueued into the queue.
message InputItem {
  // Delay duration before the item becomes available to pull. Set to 0 for immediate availability.
  google.protobuf.Duration ttl = 1;
  // Priority of the item. The lower the value, the lower the priority.
  uint32 priority = 2;
  // Grouping key of the item. Items with the same key are grouped and returned together to the same receiver when the first groupped item hits the head.
  // For example, if the first item with key "A" is pulled, all items with key "A" will be returned to the same receiver immediately after the first item is pulled.
  // Grouping has higher priority than priority.
  bytes key = 3;
  // Unique key, can be empty.
  bytes unique_key = 4;
  // Payload of the item.
  bytes value = 5;
}

// StatusCode represents the result status of an operation.
enum StatusCode {
  STATUS_CODE_OK = 0; // Operation completed successfully.
  STATUS_CODE_ERROR = 1; // General error occurred.
  STATUS_CODE_TIMEOUT = 2; // Operation timed out.
  STATUS_CODE_NOT_FOUND = 3; // Resource not found.
  STATUS_CODE_INVALID_ARGUMENT = 4; // Invalid argument provided.
  STATUS_CODE_ALREADY_EXISTS = 5; // Resource already exists.
  STATUS_CODE_QUEUE_NOT_FOUND = 6; // Queue not found.
  STATUS_CODE_ITEM_BUSY = 7; // Item is currently busy/locked.
  STATUS_CODE_QUEUE_PAUSED = 8; // Queue is paused and cannot process operations.
  STATUS_CODE_LEADER_SWITCH = 9; // Leader switch is occurring in the cluster.
  STATUS_CODE_STORAGE_NOT_FOUND = 10; // Storage not found.
  STATUS_CODE_ITEM_NOT_BUSY = 11; // Item is not busy/locked.
  STATUS_CODE_ITEM_NOT_FOUND = 12; // Item not found.
}

// QueueRequest is the main request message sent to the queue service.
message QueueRequest {
  // Correlation ID to match requests with responses.
  uint64 correlation_id = 1;
  oneof command {
    SetupRequest setup = 2; // Setup the queue connection.
    NoopRequest noop = 3; // No operation, used for keepalive.
    EnqueueRequest enqueue = 4; // Enqueue a single item.
    PullSingleRequest pull_single = 5; // Pull a single item.
    PullRequest pull = 6; // Pull multiple items.
    CommitSingleRequest commit_single = 7; // Commit a single item.
    CommitRequest commit = 8; // Commit multiple items.
    RequeueSingleRequest requeue_single = 9; // Requeue a single item.
    RequeueRequest requeue = 10; // Requeue multiple items.
    DeleteSingleRequest delete_single = 11; // Delete a single item.
    DeleteRequest delete = 12; // Delete multiple items.
    BatchEnqueueRequest batch_enqueue = 13; // Enqueue multiple items in a batch.
    GetQueueInfoRequest get_queue_info = 14; // Get information about the queue.
  }
}

// QueueResponse is the main response message from the queue service.
message QueueResponse {
  // Correlation ID matching the request.
  uint64 correlation_id = 1;
  oneof response {
    StatusResponse status = 2; // Status response for operations without data.
    EnqueueResponse enqueue = 3; // Response to enqueue operation.
    PullSingleResponse pull_single = 4; // Response to pull single operation.
    PullResponse pull = 5; // Response to pull operation.
    CommitSingleResponse commit_single = 6; // Response to commit single operation.
    CommitResponse commit = 7; // Response to commit operation.
    RequeueSingleResponse requeue_single = 8; // Response to requeue single operation.
    RequeueResponse requeue = 9; // Response to requeue operation.
    DeleteSingleResponse delete_single = 10; // Response to delete single operation.
    DeleteResponse delete = 11; // Response to delete operation.
    BatchEnqueueResponse batch_enqueue = 12; // Response to batch enqueue operation.
    GetQueueInfoResponse get_queue_info = 13; // Response to get queue info operation.
  }
}

// SetupRequest initializes the connection to a specific queue.
message SetupRequest {
  // Name of the queue to connect to.
  string queue_name = 1;
}

// NoopRequest is a no-operation request used for keepalive.
message NoopRequest {}

// StatusResponse contains the status code and optional message.
message StatusResponse {
  // Status code of the operation.
  StatusCode code = 1;
  // Optional message providing additional details.
  string message = 2;
}

// GetQueueInfoRequest retrieves information about the current queue.
message GetQueueInfoRequest {}

// GetQueueInfoResponse contains information about the queue.
message GetQueueInfoResponse {
  // Maximum size of the queue, 0 means unlimited.
  uint32 max_size = 1;
  // Current number of items in the queue.
  uint32 length = 2;
  // Number of active (pulled but not committed) items.
  uint32 active = 3;
  // Number of priority levels in the queue.
  uint32 priorities = 4;
}

// EnqueueRequest contains the item to be pushed and duration of the timeout.
message EnqueueRequest {
  InputItem item = 1;
  google.protobuf.Duration timeout = 2;
}

// BatchEnqueueRequest enqueues multiple items in a single operation.
message BatchEnqueueRequest {
  // Items to be enqueued.
  repeated InputItem items = 1;
  // Timeout duration for the operation.
  google.protobuf.Duration timeout = 2;
}

// EnqueueResponse sends back only item ID.
message EnqueueResponse {
  // Unique ID assigned to the enqueued item by the server.
  uint64 id = 1;
}

// BatchEnqueueResponse contains IDs of all enqueued items.
message BatchEnqueueResponse {
  // List of unique IDs assigned to the enqueued items.
  repeated uint64 ids = 1;
}

// PullSingleRequest message contains duration, for how long should request wait for item if the queue is empty.
message PullSingleRequest {
  google.protobuf.Duration timeout = 1;
}

// PullSingleResponse message contains the item pulled from the queue.
message PullSingleResponse {
  Item item = 1;
}

// PullRequest message: batchSize: number of items to pull, timeout: for how long should request wait for items if the queue is empty.
message PullRequest {
  int32 batch_size = 1;
  google.protobuf.Duration timeout = 2;
}

// PullResponse message has array of pulled items.
message PullResponse {
  repeated Item items = 1;
}

// CommitSingleRequest commits a single item, removing it from the queue permanently.
message CommitSingleRequest {
  // ID of the item to commit.
  uint64 id = 1;
}

// CommitSingleResponse returns true if the item was committed.
message CommitSingleResponse {
  bool committed = 1;
}

// CommitRequest sends an array of item IDs to commit.
message CommitRequest {
  repeated uint64 ids = 1;
}

// CommitResponse returns the number of items that were committed.
message CommitResponse {
  int32 ret = 1;
}

// RequeueSingleRequest message contains the ID of the item to requeue.
message RequeueSingleRequest {
  RequeueItem item = 1;
}

// RequeueSingleResponse message returns true if the item was requeued.
message RequeueSingleResponse {
  bool requeued = 1;
}

// RequeueRequest message sends an array of item IDs to requeue.
message RequeueRequest {
  repeated RequeueItem items = 1;
}

// RequeueItem specifies an item to requeue with a delay before it becomes available again.
message RequeueItem {
  // ID of the item to requeue.
  uint64 id = 1;
  // Delay duration before the requeued item becomes available to pull. Set to 0 for immediate availability.
  google.protobuf.Duration ttl = 2;
}

// RequeueResponse message returns the number of items that were requeued.
message RequeueResponse {
  int32 ret = 1;
}

// DeleteSingleRequest message contains the ID of the item to delete.
message DeleteSingleRequest {
  uint64 id = 1;
}

// DeleteSingleResponse message returns true if the item was deleted.
message DeleteSingleResponse {
  bool deleted = 1;
}

// DeleteRequest message sends an array of item IDs to delete.
message DeleteRequest {
  repeated uint64 ids = 1;
}

// DeleteResponse message returns the number of items that were deleted.
message DeleteResponse {
  int32 ret = 1;
}

// Following messages are management related only

// CreateQueueRequest message contains the data to create a new queue.
message CreateQueueRequest {
  // Non-empty name of the queue.
  string queue_name = 1;
  // Number of priorities, the lower the value, the higher the priority. The highest priority is 0, the lowest is 'priorities - 1'.
  uint32 priorities = 2;
  // Maximum number of items in the queue. If set to 0, the queue has no limit.
  uint32 max_size = 3;
}

// ResizeQueueRequest changes the maximum size of an existing queue.
message ResizeQueueRequest {
  // Non-empty name of the queue.
  string queue_name = 1;
  // Maximum number of items in the queue. If set to 0, the queue has no limit.
  uint32 max_size = 2;
}

// DeleteQueueRequest message contains the identification of the queue to delete.
message DeleteQueueRequest {
  // Name of the queue to delete.
  string queue_name = 1;
}

// ListQueuesResponse message contains an array of queues that are running on the server.
message ListQueuesResponse {
  repeated ListQueueItem queues = 1;
}

// ListQueueItem message contains the queue info.
message ListQueueItem {
  // Non-empty name of the queue.
  string queue_name = 1;
  // Number of priorities, the lower the value, the higher the priority. The highest priority is 0, the lowest is 'priorities - 1'.
  uint32 priorities = 2;
  // Maximum number of items in the queue. If set to 0, the queue has no limit.
  uint32 max_size = 3;
  // Number of items in the queue.
  uint32 count = 4;
  // Number of active unacknowledged items in the queue.
  uint32 active = 5;
  // Identifies whether the queue is paused.
  bool paused = 6;
}

// PauseQueueRequest pauses a queue, preventing new items from being pulled.
message PauseQueueRequest {
  // Name of the queue to pause.
  string queue_name = 1;
}

// ResumeQueueRequest resumes a paused queue, allowing items to be pulled again.
message ResumeQueueRequest {
  // Name of the queue to resume.
  string queue_name = 1;
}

// Storage management messages

// CreateStorageRequest creates a new key-value storage.
message CreateStorageRequest {
  // Non-empty name of the storage.
  string storage_name = 1;
}

// DeleteStorageRequest deletes an existing storage.
message DeleteStorageRequest {
  // Name of the storage to delete.
  string storage_name = 1;
}

// ListStoragesResponse contains a list of all storages.
message ListStoragesResponse {
  // List of storage items.
  repeated ListStorageItem storages = 1;
}

// ListStorageItem contains information about a single storage.
message ListStorageItem {
  // Non-empty name of the storage.
  string storage_name = 1;
  // Total number of items in the storage.
  uint32 count = 2;
  // Number of active (locked) items in the storage.
  uint32 active = 3;
}

// StorageRequest is the main request message sent to the storage service.
message StorageRequest {
  // Correlation ID to match requests with responses.
  uint64 correlation_id = 1;
  oneof command {
    StorageSetupRequest setup = 2; // Setup the storage connection.
    NoopRequest noop = 3; // No operation, used for keepalive.
    StorageSetRequest set = 4; // Set a key-value pair.
    StorageGetRequest get = 5; // Get a value by key.
    StorageDeleteRequest delete = 6; // Delete a key-value pair.
    StorageLockAnyWithIdRequest lock_any_with_id = 7; // Lock any available item and return it with ID.
    StorageReleaseIdRequest release_id = 8; // Release a locked item by ID.
    StorageGetKeysRequest get_keys = 9; // Get all keys from storage.
    StorageGetKeysNextRequest get_keys_next = 10; // Get next batch of keys.
    StorageGetInfoRequest get_info = 11; // Get storage information.
  }
}

// StorageResponse is the main response message from the storage service.
message StorageResponse {
  // Correlation ID matching the request.
  uint64 correlation_id = 1;
  oneof response {
    StatusResponse status = 2; // Status response for operations without data.
    StorageDataResponse data_response = 3; // Response containing data.
    StorageGetKeysResponse get_keys_response = 4; // Response containing keys.
    StorageGetInfoResponse get_info_response = 5; // Response containing storage info.
  }
}

// StorageGetInfoRequest retrieves information about the storage.
message StorageGetInfoRequest {}

// StorageGetInfoResponse contains information about the storage.
message StorageGetInfoResponse {
  // Total number of items in the storage.
  uint32 count = 1;
  // Number of active (locked) items.
  uint32 active = 2;
}

// StorageSetupRequest initializes the connection to a specific storage.
message StorageSetupRequest {
  // Name of the storage to connect to.
  string storage_name = 1;
}

// StorageSetRequest sets a key-value pair in the storage.
message StorageSetRequest {
  // Key to set.
  bytes key = 1;
  // Value to store.
  bytes value = 2;
  // Optional delay duration before the item becomes available for locking. Set to 0 or omit for immediate availability.
  optional google.protobuf.Duration ttl = 3;
}

// StorageGetRequest retrieves a value by key.
message StorageGetRequest {
  // Key to retrieve.
  bytes key = 1;
}

// StorageDeleteRequest deletes a key-value pair from the storage.
message StorageDeleteRequest {
  // Key to delete.
  bytes key = 1;
}

// StorageLockAnyWithIdRequest locks any available item and returns it.
message StorageLockAnyWithIdRequest {
  // Timeout duration to wait for an available item.
  google.protobuf.Duration timeout = 1;
}

// StorageReleaseIdRequest releases a locked item by its ID.
message StorageReleaseIdRequest {
  // ID of the item to release.
  uint64 id = 1;
  // If true, delete the item after releasing.
  bool delete = 2;
}

// StorageGetKeysRequest retrieves all keys from the storage.
message StorageGetKeysRequest {
  // If true, include active (locked) items in the results.
  bool active_included = 1;
}

// StorageGetKeysNextRequest retrieves the next batch of keys.
message StorageGetKeysNextRequest {}

// StorageDataResponse contains data retrieved from storage.
message StorageDataResponse {
  // ID of the item (used for locked items).
  uint64 id = 1;
  // Key of the item.
  bytes key = 2;
  // Value of the item.
  bytes value = 3;
}

// StorageGetKeysResponse contains a batch of keys.
message StorageGetKeysResponse {
  // List of keys.
  repeated bytes keys = 1;
  // If true, more keys are available to fetch.
  bool more = 2;
}
