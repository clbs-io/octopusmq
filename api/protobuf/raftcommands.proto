syntax = "proto3";
package io.clbs.octopusmq.grpc.raftcmd;

import "google/protobuf/timestamp.proto";
import "messages.proto";

option go_package = "github.com/clbs-io/octopusmq/pkg/grpcraftcmdpb";

// RaftCommand represents a command that will be replicated through the Raft consensus protocol.
message RaftCommand {
  oneof command {
    RaftCreateQueue create_queue = 1; // Create a new queue.
    io.clbs.octopusmq.protobuf.DeleteQueueRequest delete_queue = 2; // Delete an existing queue.
    RaftPauseResumeQueue pause_resume_queue = 3; // Pause or resume a queue.
    RaftPurgeItems purge_items = 4; // Purge items from queues.

    // Internal storage commands
    RaftStorageCommands storage_commands = 5; // Batch of storage operations.
    RaftStorageDeleteIds storage_delete_ids = 6; // Delete multiple items by ID.

    // Starting synchronization
    RaftStartNoop start_noop = 7; // No-op command to sync cluster start time.

    // Queue management commands
    io.clbs.octopusmq.protobuf.ResizeQueueRequest resize_queue = 8; // Resize an existing queue.

    // Storage management commands
    RaftCreateStorage create_storage = 9; // Create a new storage.
    io.clbs.octopusmq.protobuf.DeleteStorageRequest delete_storage = 10; // Delete an existing storage.
  }
}

// RaftCreateQueue creates a new queue with an assigned ID.
message RaftCreateQueue {
  // Internal queue ID assigned by the system.
  uint32 queue_id = 1;
  // Queue creation parameters.
  io.clbs.octopusmq.protobuf.CreateQueueRequest queue = 2;
}

// RaftPauseResumeQueue pauses or resumes a queue.
message RaftPauseResumeQueue {
  // Name of the queue to pause or resume.
  string queue_name = 1;
  // If true, pause the queue; if false, resume it.
  bool pause = 2;
}

// RaftPurgeItems purges expired or completed items from queues.
message RaftPurgeItems {}

// RaftStartNoop is used to synchronize cluster start time and ensure consistency.
message RaftStartNoop {
  // Timestamp when the cluster started.
  google.protobuf.Timestamp start_time = 1;
  // Unique identifier for this start operation.
  string uuid = 2;
}

// RaftStorageCommands contains a batch of storage operations to be applied atomically.
message RaftStorageCommands {
  // Internal storage ID.
  uint32 id = 1;
  // List of storage commands to execute.
  repeated RaftStorageCommand commands = 2;
}

// RaftStorageDeleteIds deletes multiple items by their IDs.
message RaftStorageDeleteIds {
  // List of IDs to delete.
  repeated uint64 ids = 1;
}

// RaftStorageCommand represents a single storage operation.
message RaftStorageCommand {
  oneof command {
    RaftStorageDelete delete = 1; // Delete an item.
    RaftStorageChange insert = 2; // Insert a new item.
    RaftStorageChange update = 3; // Update an existing item (uses same structure as insert for simplicity).
    RaftStorageUpdateMetaData update_meta = 4; // Update only the metadata of an item.
  }
}

// RaftStorageDelete deletes a single item by ID.
message RaftStorageDelete {
  // ID of the item to delete.
  uint64 id = 1;
}

// RaftStorageChange inserts or updates an item with metadata and data.
message RaftStorageChange {
  // ID of the item.
  uint64 id = 1;
  // Metadata associated with the item.
  bytes metadata = 2;
  // Data content of the item.
  bytes data = 3;
}

// RaftStorageUpdateMetaData updates only the metadata of an item.
message RaftStorageUpdateMetaData {
  // ID of the item to update.
  uint64 id = 1;
  // New metadata for the item.
  bytes metadata = 2;
}

// RaftCreateStorage creates a new storage with an assigned ID.
message RaftCreateStorage {
  // Internal storage ID assigned by the system.
  uint32 storage_id = 1;
  // Storage creation parameters.
  io.clbs.octopusmq.protobuf.CreateStorageRequest storage = 2;
}
